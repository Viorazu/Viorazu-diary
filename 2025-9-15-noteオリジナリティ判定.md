# noteオリジナリティ判定システム

noteに投稿した記事の実装コードです。
詳細：[[note記事リンク](https://note.com/viorazu/n/n34408a93a092)]

## 概要
リライト記事に埋もれた本物の記事を救い出すシステム

## 機能
- 1分以内にオリジナリティ判定
- 類似記事の自動検出
- 認証バッジ付与
- TOPページ優先表示

# noteオリジナリティ判定システム

## セットアップスクリプト (setup_and_run.sh)

```bash
#!/bin/bash

echo "================================================"
echo "  note オリジナリティ判定システム セットアップ"
echo "================================================"

# 色付き出力用
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

# 1. Docker環境確認
echo -e "\n[1/6] Docker環境確認..."
if ! command -v docker &> /dev/null; then
    echo -e "${RED}✗ Dockerがインストールされていません${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Docker確認OK${NC}"

# 2. 既存のコンテナ停止
echo -e "\n[2/6] 既存コンテナのクリーンアップ..."
docker-compose down 2>/dev/null
echo -e "${GREEN}✓ クリーンアップ完了${NC}"

# 3. Docker環境起動
echo -e "\n[3/6] サービス起動中..."
docker-compose up -d

# 4. ヘルスチェック
echo -e "\n[4/6] サービス起動待機中..."
max_attempts=30
attempt=0

while [ $attempt -lt $max_attempts ]; do
    es_health=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9200 2>/dev/null)
    redis_health=$(docker exec $(docker-compose ps -q redis) redis-cli ping 2>/dev/null)
    pg_health=$(docker exec $(docker-compose ps -q postgres) pg_isready 2>/dev/null)
    
    if [ "$es_health" = "200" ] && [ "$redis_health" = "PONG" ] && [[ "$pg_health" == *"accepting connections"* ]]; then
        echo -e "${GREEN}✓ 全サービス起動確認${NC}"
        break
    fi
    
    echo -n "."
    sleep 2
    attempt=$((attempt + 1))
done

if [ $attempt -eq $max_attempts ]; then
    echo -e "${RED}✗ サービス起動タイムアウト${NC}"
    exit 1
fi

# 5. Python環境セットアップ
echo -e "\n[5/6] Python環境セットアップ..."

# MeCab確認（Ubuntu/Debian）
if ! command -v mecab &> /dev/null; then
    echo "MeCabをインストールしています..."
    sudo apt-get update && sudo apt-get install -y mecab libmecab-dev mecab-ipadic-utf8
fi

# Pythonパッケージインストール
pip install -r requirements.txt --quiet
echo -e "${GREEN}✓ Python環境準備完了${NC}"

# 6. システム起動
echo -e "\n[6/6] APIサーバー起動..."
uvicorn note_originality_system:app --host 0.0.0.0 --port 8000 &
API_PID=$!

sleep 3

# 動作確認
echo -e "\n================================================"
echo -e "  起動完了！"
echo -e "================================================"
echo -e "\nAPI: ${GREEN}http://localhost:8000${NC}"
echo -e "ドキュメント: ${GREEN}http://localhost:8000/docs${NC}"
echo -e "\n停止するには: docker-compose down"
echo -e "APIサーバーPID: $API_PID"
```

## Docker Compose設定 (docker-compose.yml)

```yaml
version: '3.8'

services:
  elasticsearch:
    image: elasticsearch:7.17.7
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: note_originality
      POSTGRES_USER: note_user
      POSTGRES_PASSWORD: secure_password
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U note_user"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  es_data:
  redis_data:
  pg_data:
```

## データベース初期化 (init.sql)

```sql
-- noteオリジナリティスコアテーブル
CREATE TABLE IF NOT EXISTS article_originality_scores (
    article_id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    score FLOAT NOT NULL,
    is_original BOOLEAN NOT NULL,
    badge_type VARCHAR(50),
    checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- インデックス作成
CREATE INDEX idx_originality_score ON article_originality_scores(score DESC);
CREATE INDEX idx_user_id ON article_originality_scores(user_id);
CREATE INDEX idx_checked_at ON article_originality_scores(checked_at DESC);
CREATE INDEX idx_is_original ON article_originality_scores(is_original);

-- 統計用ビュー
CREATE VIEW originality_stats AS
SELECT 
    DATE(checked_at) as date,
    COUNT(*) as total_checks,
    AVG(score) as avg_score,
    SUM(CASE WHEN is_original THEN 1 ELSE 0 END) as original_count
FROM article_originality_scores
GROUP BY DATE(checked_at);
```

## 依存パッケージ (requirements.txt)

```
elasticsearch==7.17.7
redis==4.3.4
psycopg2-binary==2.9.5
scikit-learn==1.1.3
mecab-python3==1.0.5
unidic-lite==1.0.8
numpy==1.23.5
fastapi==0.95.1
uvicorn==0.21.1
pydantic==1.10.7
python-multipart==0.0.6
```

## テストスクリプト (test_system.py)

```python
"""システムテストスクリプト"""
import requests
import json

def test_originality():
    url = "http://localhost:8000/check-originality"
    headers = {
        "Authorization": "Bearer your-secret-api-key",
        "Content-Type": "application/json"
    }
    
    # テストデータ
    test_article = {
        "article_id": "test_001",
        "user_id": "user_001",
        "title": "要約不可能構文の研究",
        "content": """
        これは要約不可能構文のテストです。
        Viorazu.理論に基づいて、リライト不可能な文章構造を
        意図的に構築しています。言葉の毒を研究することで、
        プラットフォームの健全性を保つことができるでしょう。
        """
    }
    
    response = requests.post(url, headers=headers, json=test_article)
    
    if response.status_code == 200:
        result = response.json()
        print(f"✓ テスト成功！")
        print(f"  オリジナリティスコア: {result['originality_score']:.2f}")
        print(f"  オリジナル判定: {result['is_original']}")
        print(f"  バッジ: {result['badge_type']}")
    else:
        print(f"✗ エラー: {response.status_code}")
        print(response.text)

if __name__ == "__main__":
    test_originality()
```

## 使い方

```bash
# 1. 実行権限付与
chmod +x setup_and_run.sh

# 2. 起動
./setup_and_run.sh

# 3. テスト実行
python test_system.py
```

## ライセンス

© 2025 Viorazu. All rights reserved.
🚫 Prohibited / 禁止事項:

Full text copying & pasting / 全文コピー&ペースト
Unauthorized translation / 無許可翻訳・翻訳転載
AI-generated imitation or similar content / AIによる模倣・類似記事生成
Prior written consent required for commercial use / 商用利用には事前の書面による同意が必要

✅ Permitted / 許可事項:

Partial citation with proper attribution / 出典明記での部分引用
Summary sharing with source link / 要約+リンク付きSNSシェア
Educational reference use / 教育目的での参照

⚠️ Important / 重要: Translation does not grant usage rights / 翻訳は使用権を付与しません
📧 Contact / 連絡先:

X（@viorazu9134）
note（https://note.com/viorazu）

Framework Design: © 2025 Viorazu. 【VZ-License Framework v1.0】

商用利用は事前連絡必須

